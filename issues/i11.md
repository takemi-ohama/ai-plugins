# 指示書：Claude Code Plugin

## Redash MCP マルチ環境設定プラグイン（任意 suffix 対応）

## 1. 目的

Claude Code の Plugin として `mcp-redash`
[https://github.com/suthio/redash-mcp](https://github.com/suthio/redash-mcp)
を追加する。

本プラグインは **Redash MCP を1つ以上、任意の suffix で追加可能**とし、

* デフォルトは **suffix なし（`redash`）を1つだけ自動有効化**
* 追加の Redash（`dev`, `stg`, `prod2`, `sandbox` など）は
  **Skill をスラッシュコマンドとして実行したときだけ追加**

することで、

* 1つだけ使うプロジェクトでは `/mcp` が汚れない
* 複数環境を扱うプロジェクトでも柔軟に増やせる
* URL / API_KEY はすべて **プロジェクト側環境変数で設定可能**

という状態を実現する。

---

## 2. 基本設計方針（重要）

### ✔ MCPの表示制御

* **Plugin 同梱 MCP は1つだけ**
* 追加 MCP は **project `.mcp.json` に明示的に追加されたものだけ**
* したがって `/mcp` には「本当に使うものだけ」が表示される

### ✔ Skill = スラッシュコマンド

* 最新 Claude Code では **Skill は `/skill-name` として直接呼び出せる**
* すべての操作（add / remove / list / status）は **Skill で実装**
* `commands/` は使わない

---

## 3. MCP / env 命名ルール

### 3.1 デフォルト（suffixなし・1つ目）

| 項目      | 値                |
| ------- | ---------------- |
| MCP名    | `redash`         |
| URL     | `REDASH_URL`     |
| API Key | `REDASH_API_KEY` |

※ **suffixなしは特別扱い**
→ 1つだけ使うプロジェクトではこれだけ設定すればよい

---

### 3.2 suffix 付き（任意個）

suffix を `X` とした場合：

| 項目      | 値                  |
| ------- | ------------------ |
| MCP名    | `redash-X`         |
| URL     | `REDASH_X_URL`     |
| API Key | `REDASH_X_API_KEY` |

#### 例

* `/redash-add dev`

  * MCP: `redash-dev`
  * env: `REDASH_DEV_URL`, `REDASH_DEV_API_KEY`
* `/redash-add stg`

  * MCP: `redash-stg`
  * env: `REDASH_STG_URL`, `REDASH_STG_API_KEY`
* `/redash-add sandbox`

  * MCP: `redash-sandbox`
  * env: `REDASH_SANDBOX_URL`, `REDASH_SANDBOX_API_KEY`

---

## 4. Plugin 同梱 MCP（必須）

### `.mcp.json`（plugin ルート）

**必ず `redash` 1つだけを定義すること。**

```json
{
  "mcpServers": {
    "redash": {
      "command": "npx",
      "args": ["-y", "@suthio/redash-mcp"],
      "env": {
        "REDASH_URL": "${REDASH_URL}",
        "REDASH_API_KEY": "${REDASH_API_KEY}"
      }
    }
  }
}
```

* dev / stg / その他 suffix は **ここに書かない**
* これにより Plugin インストール直後の `/mcp` には `redash` しか出ない

---

## 5. Skill（スラッシュコマンド）仕様

### 共通事項

* Skill は `skills/` 配下に配置
* `disable-model-invocation: true` を必ず指定
* 実処理は Node.js スクリプトを呼び出す

---

### 5.1 `/redash-add <suffix>`

#### 目的

任意 suffix の Redash MCP を **project `.mcp.json` に追加**

#### 振る舞い

* `<suffix>` が空 or `default` の場合 → エラー（`redash` は追加不可）
* 既に存在する場合 → 何も変更せず成功メッセージ
* `.mcp.json` が無い場合 → 新規作成
* JSON が壊れている場合 → エラーで中断（上書きしない）

#### 生成される MCP 定義（例：suffix = dev）

```json
"redash-dev": {
  "command": "npx",
  "args": ["-y", "@suthio/redash-mcp"],
  "env": {
    "REDASH_URL": "${REDASH_DEV_URL}",
    "REDASH_API_KEY": "${REDASH_DEV_API_KEY}"
  }
}
```

---

### 5.2 `/redash-remove <suffix>`

#### 目的

指定 suffix の MCP を project `.mcp.json` から削除

#### 振る舞い

* 存在しない場合 → 何もせず成功扱い
* `suffix = default` or 空 → エラー（`redash` は削除不可）

---

### 5.3 `/redash-list`

#### 目的

現在有効な Redash MCP を一覧表示

#### 表示内容（例）

```
redash        (plugin bundled)
redash-dev    (project)
redash-stg    (project)
```

---

### 5.4 `/redash-status`

#### 目的

設定状況の詳細確認

* 有効な MCP 一覧
* 各 MCP が必要とする env 変数名
* env が未設定と思われるものがあれば警告（値は表示しない）

---

## 6. Skill frontmatter 例

```markdown
---
name: redash-add
description: 任意 suffix の Redash MCP を追加する
disable-model-invocation: true
arguments:
  - name: suffix
    description: dev, stg, sandbox など
---
```

※ Claude Code の最新仕様では、この Skill を

```
/redash-add dev
```

のように **スラッシュコマンドとして直接実行可能**。

---

## 7. JSON 編集スクリプト要件

* Node.js で実装（必須）
* 役割

  1. project root の `.mcp.json` を探す（cwd 前提でOK）
  2. JSON parse
  3. `mcpServers` の add / remove / list
  4. 整形して保存（2 spaces）
* 破損 JSON は絶対に自動修復しない

---

## 8. Skill（ドキュメント用）

`skills/redash-guide.md` を作成し、以下を記載：

* 基本は `REDASH_` だけ設定すればOK
* 複数環境を使いたい場合の例
* suffix 命名ルール
* `/redash-add` → env 設定 → `/mcp` 確認 の流れ
* 不要になったら `/redash-remove`

---

## 9. 成果物一覧（必須）

* `.mcp.json`（plugin bundled / redashのみ）
* `skills/`

  * `redash-add.md`
  * `redash-remove.md`
  * `redash-list.md`
  * `redash-status.md`
  * `redash-guide.md`
* `scripts/redash-mcp-config.js`
* `.env.sample`
* `README.md`

---

## 10. 受け入れ基準

1. Plugin導入直後 `/mcp` に `redash` しか出ない
2. `/redash-add dev` 実行後に `redash-dev` が出る
3. `/redash-add foo` が問題なく動く
4. `/redash-remove dev` 後に `/mcp` から消える
5. suffix をいくつ追加しても衝突しない
6. env 未設定でも **追加はできるが警告が出る**

---

## 11. 設計意図（README に明記）

> 本プラグインは
> 「1つだけ使う場合は最小設定」
> 「必要になったら suffix 付きで増やす」
> という運用を前提にしている。
>
> そのため MCP 定義は **必要になるまで作られない**。

