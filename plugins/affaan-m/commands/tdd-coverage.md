# TDD COVERAGE フェーズコマンド

## コマンド名
`/tdd-coverage`

## 説明
TDDのCOVERAGEフェーズ - テストカバレッジを検証し、未カバー箇所を特定します。

## 使用方法

```bash
/tdd-coverage [機能名]
```

**例**:
```bash
/tdd-coverage "ユーザー認証機能"
```

## COVERAGEフェーズの目的

**「テストカバレッジの検証」**

- カバレッジ目標（80%以上）の達成確認
- 未カバー箇所の特定
- 追加テストの必要性判断

## 実行ステップ

### 1. カバレッジ測定

```bash
# Jest の場合
npm test -- --coverage

# Vitest の場合
npm test -- --coverage

# c8 (Node.js) の場合
npx c8 npm test
```

### 2. カバレッジレポート確認

**コンソール出力例**:
```
---------------------------|---------|----------|---------|---------|
File                       | % Stmts | % Branch | % Funcs | % Lines |
---------------------------|---------|----------|---------|---------|
All files                  |   85.7  |   80.5   |   90.0  |   85.7  |
 auth.ts                   |   90.0  |   85.0   |  100.0  |   90.0  |
 user.ts                   |   80.0  |   75.0   |   80.0  |   80.0  |
---------------------------|---------|----------|---------|---------|
```

### 3. 未カバー箇所の分析

**HTMLレポート確認**:
```bash
open coverage/index.html
```

## チェックポイント

### ✅ 目標達成
- **全体カバレッジ**: 80%以上
- **関数カバレッジ**: 85%以上
- **分岐カバレッジ**: 75%以上
- **行カバレッジ**: 80%以上

### ⚠️ 追加テスト検討
- 全体カバレッジ: 70-80%
- 重要な分岐が未カバー
- エラーハンドリングが未テスト

### ❌ カバレッジ不足
- 全体カバレッジ: 70%未満
- 主要機能が未テスト
- 多数の分岐が未カバー

## 出力例

```
📊 COVERAGEフェーズ: テストカバレッジを検証
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【カバレッジ測定結果】
  ✅ 全体: 85.7% (目標: 80%以上)
  ✅ 関数: 90.0% (目標: 85%以上)
  ⚠️  分岐: 75.0% (目標: 75%以上)
  ✅ 行: 85.7% (目標: 80%以上)

【ファイル別カバレッジ】
  ✅ auth.ts: 90.0%
  ⚠️  user.ts: 80.0%
  ✅ utils.ts: 95.0%

【未カバー箇所】
  1. user.ts:45-50 - エラーハンドリング
  2. user.ts:78-82 - エッジケース処理

【推奨事項】
  ⚠️  user.ts のエラーケースに追加テストを検討
  ✅ 全体的には目標を達成しています

【TDDワークフロー完了】
  🎉 すべてのフェーズが完了しました！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## カバレッジ目標

### 機能別推奨カバレッジ

| 機能カテゴリ | 推奨カバレッジ | 理由 |
|-------------|---------------|------|
| セキュリティ機能 | 90%以上 | 脆弱性リスクが高い |
| ビジネスロジック | 85%以上 | バグの影響が大きい |
| ユーティリティ | 80%以上 | 汎用的に使用される |
| UIコンポーネント | 70%以上 | 手動テストも併用 |
| 設定ファイル | 60%以上 | 静的な内容が多い |

### カバレッジタイプの説明

**Statement Coverage（文カバレッジ）**:
- すべてのコード行が実行されたか
- 最も基本的なカバレッジ指標

**Branch Coverage（分岐カバレッジ）**:
- すべての条件分岐が実行されたか
- if文、switch文の全パターン

**Function Coverage（関数カバレッジ）**:
- すべての関数が呼び出されたか
- 未使用関数の検出に有効

**Line Coverage（行カバレッジ）**:
- すべてのコード行が実行されたか
- Statement Coverageとほぼ同義

## 追加テストの判断

### 追加テストが必要なケース

**高優先度**:
- セキュリティに関わる箇所
- エラーハンドリング
- 主要なビジネスロジック
- 外部API連携部分

**中優先度**:
- エッジケース
- 境界値テスト
- 複雑な条件分岐

**低優先度**:
- 単純なGetter/Setter
- 定数定義
- 型定義のみのファイル

### 追加テストが不要なケース

- 自動生成コード
- サードパーティライブラリのラッパー（薄いラッパー）
- 設定ファイル
- 型定義ファイル

## NDFプラグインとの連携

### qaエージェント
`ndf:qa`がカバレッジを分析：
- 未カバー箇所の優先順位付け
- 追加テストの提案
- カバレッジトレンドの監視

### corderエージェント
`ndf:corder`が追加テストを生成：
- 未カバー箇所のテストコード
- エッジケースのテスト
- エラーケースのテスト

## affaan-mプラグインのHooks

### coverage-check Hook
PreCommit時に自動カバレッジチェック：

**設定**（plugin.json）:
```json
{
  "config": {
    "tdd": {
      "coverageThreshold": 80
    }
  }
}
```

**動作**:
- コミット前に自動実行
- 目標未達時に警告表示
- ただしコミットはブロックしない（警告のみ）

## カバレッジレポートの読み方

### HTMLレポート

**未カバー箇所の色分け**:
- 🟢 **緑**: テストでカバーされている
- 🔴 **赤**: テストでカバーされていない
- 🟡 **黄**: 部分的にカバー（分岐の一部のみ）

### コンソール出力

```
File         | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
-------------|---------|----------|---------|---------|------------------
auth.ts      |   90.00 |    85.00 |  100.00 |   90.00 | 45-50
```

**Uncovered Line #s**: 未カバーの行番号

## カバレッジ向上のヒント

### 1. エラーケースをテスト

```typescript
it('存在しないユーザーでエラー', async () => {
  await expect(
    authenticateUser('nonexistent@example.com', 'password')
  ).rejects.toThrow('User not found');
});
```

### 2. 境界値をテスト

```typescript
describe('年齢検証', () => {
  it('17歳は未成年', () => {
    expect(isAdult(17)).toBe(false);
  });

  it('18歳は成年', () => {
    expect(isAdult(18)).toBe(true);
  });
});
```

### 3. すべての分岐をテスト

```typescript
// if-else の両方をカバー
it('条件A: trueの場合', () => { });
it('条件A: falseの場合', () => { });

// switch の全caseをカバー
it('ケース1', () => { });
it('ケース2', () => { });
it('デフォルトケース', () => { });
```

## 注意事項

### カバレッジの限界
- ❗ **100%カバレッジ ≠ バグゼロ**
- ❗ カバレッジは品質の一指標に過ぎない
- ❗ テストの質も重要（適切なアサーション）

### バランスが重要
- 過度なカバレッジ追求は避ける
- メンテナンスコストを考慮
- 80%を目標、90%以上は必要に応じて

## トラブルシューティング

### カバレッジが計測されない
```bash
# 設定ファイルを確認
cat jest.config.js
cat vitest.config.ts

# カバレッジツールのインストール確認
npm list --depth=0 | grep coverage
```

### カバレッジが低すぎる
- 主要機能のテストから始める
- 段階的にカバレッジを向上
- 優先順位をつける（セキュリティ → ビジネスロジック）

### カバレッジレポートが見つからない
```bash
# レポート生成ディレクトリを確認
ls -la coverage/

# 手動でレポート生成
npm test -- --coverage
```

## 次のステップ

COVERAGEフェーズが完了したら：

### カバレッジ目標達成の場合
- コミットしてPR作成
- セキュリティレビュー（`/security-scan`）
- コードレビュー依頼

### カバレッジ不足の場合
- 追加テストを作成（RED → GREEN → REFACTOR）
- 再度`/tdd-coverage`を実行

## 関連ドキュメント

- [TDDワークフロー](./tdd.md)
- [セキュリティスキャン](./security-scan.md)

## 参考

- [Jest Coverage](https://jestjs.io/docs/configuration#collectcoverage-boolean)
- [Vitest Coverage](https://vitest.dev/guide/coverage.html)
- [c8 - Code Coverage](https://github.com/bcoe/c8)
- [Istanbul (nyc)](https://istanbul.js.org/)
