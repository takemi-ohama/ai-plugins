# PR Test Plan実行

このコマンドは、`/ndf:pr`コマンドで作成されたPRのTest Planを自動実行します。

## 概要

PRの本文に記載されたTest Plan（チェックリスト形式）を読み取り、各テスト項目を自動で実行します。テスト結果に基づいてPRコメントを更新し、成功したテストにチェックマークを付け、失敗したテストについてはコードを修正またはコメントを追加します。

## 引数

- **PR番号**（オプション）: 指定しない場合は現在のブランチから自動検出

**使用例**:
```bash
# 現在のブランチのPRをテスト
/ndf:pr-tests

# 特定のPR番号を指定
/ndf:pr-tests 123
```

## 実行手順

### 1. PR情報取得

**ステップ**:
- 引数でPR番号が指定されている場合: その番号を使用
- 指定されていない場合: `gh pr view --json number`で現在のブランチのPRを取得
- GitHub MCPまたは`gh pr view`でPRの本文を取得
- Test Planセクションを抽出
- チェックリスト項目をパース（`- [ ]`形式）

**エラーハンドリング**:
- PRが存在しない場合: エラーメッセージを表示して終了
- Test Planが見つからない場合: 警告を表示して終了

### 2. テスト実行計画の立案

**ステップ**:
- 各テスト項目を解析
- テストの種類を判定（機能テスト、統合テスト、手動確認など）
- 実行順序を決定（依存関係を考慮）
- 自動実行可能なテストと手動確認が必要なテストを分類

**テスト種類の例**:
- プラグインのインストール/再読み込み
- コマンドの実行
- ファイルの存在確認
- コードの構文チェック
- セキュリティスキャン
- 機能の動作確認

### 3. テスト実行

**ステップ**:
- 各テスト項目を順次実行
- 実行状況をリアルタイムで報告
- 各テストの成功/失敗を記録
- エラーが発生した場合は詳細を記録

**実行方法**:
- コマンド実行系: Bashツールで実行
- ファイル確認系: Read/Globツールで確認
- コード検証系: 適切なMCPツールを使用
- 手動確認系: ユーザーに確認を求める

### 4. 結果反映

**成功したテストの場合**:
- PRの本文を更新
- `- [ ]`を`- [x]`に変更
- GitHub MCPまたは`gh pr edit`を使用

**失敗したテストの場合**:
- **原因がコードの場合**:
  1. コードを修正
  2. `git add` → `git commit` → `git push`
  3. PRにコメントを追加（修正内容を説明）
  4. GitHub MCPまたは`gh pr comment`を使用

- **コードで修正できない場合**:
  1. PRにコメントを追加
  2. 失敗理由と手動確認が必要な旨を説明
  3. 次のアクションを提案

### 5. 最終報告

**テスト結果サマリーをPRにコメント**:

```markdown
## 🧪 Test Plan実行結果

### 実行サマリー

| 項目 | 値 |
|------|-----|
| 総テスト数 | N件 |
| ✅ 成功 | X件 |
| ❌ 失敗 | Y件 |
| ⏭️ スキップ | Z件 |
| 成功率 | XX% |

### テスト結果詳細

#### ✅ 成功したテスト (X件)
1. [テスト項目1]
2. [テスト項目2]

#### ❌ 失敗したテスト (Y件)
1. **[テスト項目3]**
   - エラー: [エラー内容]
   - 対応: [コード修正 / 手動確認必要]
   - コミット: `abc1234`（修正した場合）

#### ⏭️ スキップしたテスト (Z件)
1. [テスト項目4] - 理由: [スキップ理由]

### 次のアクション

- [ ] 失敗したテストの手動確認
- [ ] 修正内容のレビュー
- [ ] 追加修正が必要な場合は対応
```

## 注意事項

### セキュリティ
- コード修正時は既存機能に影響を与えないよう注意
- 機密情報（トークン、パスワード等）をコミットしない
- git操作は安全に実行（mainブランチへの直接プッシュ禁止）

### エラーハンドリング
- 各テストで発生したエラーは詳細にログ記録
- テスト実行中のエラーで全体を停止しない（可能な限り継続）
- 致命的なエラーの場合は適切にユーザーに報告

### GitHub API制限
- GitHub APIのレート制限を考慮
- 大量のコメントを一度に投稿しない
- 可能な限りバッチ処理を使用

## 実装の参考

- **PR読み込み**: `gh pr view [番号] --json body` または GitHub MCP
- **PRコメント追加**: `gh pr comment [番号] --body "コメント"` または GitHub MCP
- **PR本文更新**: `gh pr edit [番号] --body "新しい本文"` または GitHub MCP
- **git操作**: `/ndf:pr`コマンドのロジックを参考

## Test Plan解析のロジック

**パース処理**:
```
1. PR本文を取得
2. "## Test plan" または "## Test Plan" セクションを検索
3. セクション内の "- [ ]" 行を抽出
4. 各行をテスト項目として配列化
5. チェック済み項目 "- [x]" は除外（既に実行済み）
```

**テスト項目の分類**:
- "インストール", "install" → プラグインインストールテスト
- "実行", "run", "動作" → 機能実行テスト
- "ファイル", "file", "存在" → ファイル確認テスト
- "セキュリティ", "security" → セキュリティスキャン
- "確認", "check" → 手動確認（ユーザーに確認を求める）

## 作業完了報告（必須）

作業完了時は以下の情報を必ず報告すること：

### 報告テンプレート

```
PR Test Plan実行が完了しました。

## 実行サマリー

| 項目 | 値 |
|------|-----|
| PR番号 | #123 |
| PRタイトル | [PRのタイトル] |
| 実行日時 | YYYY-MM-DD HH:MM:SS |
| 総テスト数 | N件 |
| ✅ 成功 | X件 |
| ❌ 失敗 | Y件 |
| ⏭️ スキップ | Z件 |
| 成功率 | XX% |
| 所要時間 | 約N分 |

## テスト結果詳細

| # | テスト項目 | 結果 | 備考 |
|---|-----------|------|------|
| 1 | [テスト項目1] | ✅ | 正常に実行 |
| 2 | [テスト項目2] | ✅ | 正常に実行 |
| 3 | [テスト項目3] | ❌ | エラー: [内容] |
| 4 | [テスト項目4] | ⏭️ | スキップ: [理由] |

## 実施した対応

### コード修正
- **ファイル**: `path/to/file.js`
- **内容**: [修正内容]
- **コミット**: `abc1234`

### PRコメント追加
- コメント数: M件
- 内容: [コメント概要]

### PR本文更新
- 更新したチェック項目: X件
- 残りの未チェック項目: Y件

## 次のアクション

| タスク | 状態 |
|--------|------|
| 失敗したテストの手動確認 | ⏳ 要対応 |
| コード修正のレビュー | ⏳ 要対応 |
| 追加修正 | ⏳ 要対応 |

---

## 📎 リンク

**PR URL**: https://github.com/owner/repo/pull/123
```

### 報告例

```
PR Test Plan実行が完了しました。

## 実行サマリー

| 項目 | 値 |
|------|-----|
| PR番号 | #13 |
| PRタイトル | feat: affaan-mプラグインのフックスクリプトをClaude Code仕様に実装 |
| 実行日時 | 2026-02-01 12:00:00 |
| 総テスト数 | 5件 |
| ✅ 成功 | 4件 |
| ❌ 失敗 | 1件 |
| ⏭️ スキップ | 0件 |
| 成功率 | 80% |
| 所要時間 | 約12分 |

## テスト結果詳細

| # | テスト項目 | 結果 | 備考 |
|---|-----------|------|------|
| 1 | affaan-mプラグインを再インストールできること | ✅ | 正常にインストール完了 |
| 2 | 各フックスクリプトが個別実行できること | ✅ | 全7スクリプトが正常動作 |
| 3 | secret-scanがシークレットを検出できること | ✅ | テストケースで検出確認 |
| 4 | typescript-checkが型エラーを検出できること | ❌ | TypeScriptがインストールされていない |
| 5 | hooks.jsonが正しい構造であること | ✅ | JSON構文チェック合格 |

## 実施した対応

### コード修正
- **ファイル**: `plugins/affaan-m/scripts/typescript-check.js`
- **内容**: TypeScript未インストール時のエラーハンドリング追加
- **コミット**: `def5678`

### PRコメント追加
- コメント数: 2件
- 内容: TypeScript未インストール時の動作説明と推奨インストール手順

### PR本文更新
- 更新したチェック項目: 4件（✅マーク追加）
- 残りの未チェック項目: 1件（手動確認待ち）

## 次のアクション

| タスク | 状態 |
|--------|------|
| TypeScriptのインストール | ⏳ 要対応 |
| typescript-check再テスト | ⏳ 要対応 |
| コード修正のレビュー | ✅ 完了 |

---

## 📎 リンク

**PR URL**: https://github.com/takemi-ohama/ai-plugins/pull/13
```

## 備考

- このコマンドは`/ndf:pr`コマンドとセットで使用することを想定
- Test Planの形式は`/ndf:pr`が生成する形式に対応
- 自動実行できないテストは手動確認をユーザーに依頼
- テスト実行の進捗はリアルタイムでユーザーに報告
