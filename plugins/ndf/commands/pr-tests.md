# PR Test Plan実行

このコマンドは、`/ndf:pr`コマンドで作成されたPRのTest Planを自動実行します。

## 概要

PRの本文に記載されたTest Plan（チェックリスト形式）を読み取り、各テスト項目を自動で実行します。テスト結果に基づいてPRコメントを更新し、成功したテストにチェックマークを付け、失敗したテストについては問題点と対策案をPRコメントに追加します。

**重要**: このコマンドはテスト実行と結果報告のみを行います。コード修正は一切行いません。

## 引数

- **PR番号**（オプション）: 指定しない場合は現在のブランチから自動検出

**使用例**:
```bash
# 現在のブランチのPRをテスト
/ndf:pr-tests

# 特定のPR番号を指定
/ndf:pr-tests 123
```

## コマンドの方針

### 実施すること

✅ **テスト実行**: 各テスト項目を自動実行
✅ **結果記録**: 成功/失敗を記録
✅ **チェックマーク更新**: 成功したテストにチェックマーク
✅ **問題報告**: 失敗したテストの問題点と対策案をPRコメントに追加

### 実施しないこと

❌ **コード修正**: 一切行わない
❌ **git操作**: commit、pushは行わない
❌ **ファイル編集**: テスト以外でのファイル変更は行わない

## 実行手順

### 1. PR情報取得

**ステップ**:
- 引数でPR番号が指定されている場合: その番号を使用
- 指定されていない場合: `gh pr view --json number`で現在のブランチのPRを取得
- GitHub MCPまたは`gh pr view`でPRの本文を取得
- Test Planセクションを抽出
- チェックリスト項目をパース（`- [ ]`形式）

**エラーハンドリング**:
- PRが存在しない場合: エラーメッセージを表示して終了
- Test Planが見つからない場合: 警告を表示して終了

### 2. テスト実行計画の立案

**ステップ**:
- 各テスト項目を解析
- テストの種類を判定（機能テスト、統合テスト、手動確認など）
- 実行順序を決定（依存関係を考慮）
- 自動実行可能なテストと手動確認が必要なテストを分類

**テスト種類の例**:
- プラグインのインストール/再読み込み
- コマンドの実行
- ファイルの存在確認
- コードの構文チェック
- セキュリティスキャン
- 機能の動作確認

### 3. テスト実行

**ステップ**:
- 各テスト項目を順次実行
- 実行状況をリアルタイムで報告
- 各テストの成功/失敗を記録
- エラーが発生した場合は詳細を記録

**実行方法**:
- コマンド実行系: Bashツールで実行
- ファイル確認系: Read/Globツールで確認
- コード検証系: 適切なMCPツールを使用
- 手動確認系: ユーザーに確認を求める

### 4. 結果反映

**成功したテストの場合**:
- PRの本文を更新
- `- [ ]`を`- [x]`に変更
- GitHub MCPまたは`gh pr edit`を使用

**失敗したテストの場合**:
- PRにコメントを追加
- 問題点を詳細に説明
- 対策案を提案
- 関連するエラーログやスタックトレースを含める
- 必要に応じて関連ドキュメントへのリンクを提供

**コメントフォーマット**:
```markdown
## ❌ テスト失敗: [テスト項目名]

### 問題点
[何が失敗したのか詳細に説明]

### エラー詳細
```
[エラーメッセージ、スタックトレース等]
```

### 対策案
1. [対策案1の説明]
2. [対策案2の説明]
3. [対策案3の説明]

### 関連情報
- [関連ドキュメントへのリンク]
- [参考になるissueやPRへのリンク]
```

### 5. 最終報告

**テスト結果サマリーをPRにコメント**:

```markdown
## 🧪 Test Plan実行結果

### 実行サマリー

| 項目 | 値 |
|------|-----|
| 総テスト数 | N件 |
| ✅ 成功 | X件 |
| ❌ 失敗 | Y件 |
| ⏭️ スキップ | Z件 |
| 成功率 | XX% |

### テスト結果詳細

#### ✅ 成功したテスト (X件)
1. [テスト項目1]
2. [テスト項目2]

#### ❌ 失敗したテスト (Y件)
1. **[テスト項目3]**
   - 問題: [問題の概要]
   - 対策: [対策案の概要]
   - 詳細: #[コメント番号]

#### ⏭️ スキップしたテスト (Z件)
1. [テスト項目4] - 理由: [スキップ理由]

### 次のアクション

- [ ] 失敗したテストの対策案を確認
- [ ] 必要に応じてコードを修正
- [ ] 修正後に再度`/ndf:pr-tests`を実行
```

## 注意事項

### テスト実行の制約

- **読み取り専用**: テスト実行はすべて読み取り専用で行う
- **副作用なし**: ファイルシステムへの書き込みは行わない
- **安全性優先**: 本番環境に影響を与える可能性のあるテストはスキップ

### エラーハンドリング

- 各テストで発生したエラーは詳細にログ記録
- テスト実行中のエラーで全体を停止しない（可能な限り継続）
- 致命的なエラーの場合は適切にユーザーに報告

### GitHub API制限

- GitHub APIのレート制限を考慮
- 大量のコメントを一度に投稿しない
- 可能な限りバッチ処理を使用

## 実装の参考

- **PR読み込み**: `gh pr view [番号] --json body` または GitHub MCP
- **PRコメント追加**: `gh pr comment [番号] --body "コメント"` または GitHub MCP
- **PR本文更新**: `gh pr edit [番号] --body "新しい本文"` または GitHub MCP

## Test Plan解析のロジック

**パース処理**:
```
1. PR本文を取得
2. "## Test plan" または "## Test Plan" セクションを検索
3. セクション内の "- [ ]" 行を抽出
4. 各行をテスト項目として配列化
5. チェック済み項目 "- [x]" は除外（既に実行済み）
```

**テスト項目の分類**:
- "インストール", "install" → プラグインインストールテスト
- "実行", "run", "動作" → 機能実行テスト
- "ファイル", "file", "存在" → ファイル確認テスト
- "セキュリティ", "security" → セキュリティスキャン
- "確認", "check" → 手動確認（ユーザーに確認を求める）

## 作業完了報告（必須）

作業完了時は以下の情報を必ず報告すること：

### 報告テンプレート

```
PR Test Plan実行が完了しました。

## 実行サマリー

| 項目 | 値 |
|------|-----|
| PR番号 | #123 |
| PRタイトル | [PRのタイトル] |
| 実行日時 | YYYY-MM-DD HH:MM:SS |
| 総テスト数 | N件 |
| ✅ 成功 | X件 |
| ❌ 失敗 | Y件 |
| ⏭️ スキップ | Z件 |
| 成功率 | XX% |
| 所要時間 | 約N分 |

## テスト結果詳細

| # | テスト項目 | 結果 | 備考 |
|---|-----------|------|------|
| 1 | [テスト項目1] | ✅ | 正常に実行 |
| 2 | [テスト項目2] | ✅ | 正常に実行 |
| 3 | [テスト項目3] | ❌ | エラー: [内容] |
| 4 | [テスト項目4] | ⏭️ | スキップ: [理由] |

## 追加したPRコメント

### 失敗したテスト
- **テスト項目3**: 問題点と対策案を#[コメント番号]に追加

### 最終報告
- テスト結果サマリーを#[コメント番号]に追加

## 次のアクション

失敗したテストがある場合:
1. PRコメントで問題点と対策案を確認
2. 必要に応じてコードを修正
3. 修正後に再度`/ndf:pr-tests`を実行

すべてのテストが成功した場合:
1. PRをレビュー依頼
2. マージの準備完了
```

### 報告例

```
PR Test Plan実行が完了しました。

## 実行サマリー

| 項目 | 値 |
|------|-----|
| PR番号 | #19 |
| PRタイトル | feat: /ndf:pr-testsコマンドを追加してPR Test Planの自動実行を実装 |
| 実行日時 | 2026-02-01 05:00:00 |
| 総テスト数 | 6件 |
| ✅ 成功 | 5件 |
| ❌ 失敗 | 1件 |
| ⏭️ スキップ | 0件 |
| 成功率 | 83% |
| 所要時間 | 約3分 |

## テスト結果詳細

| # | テスト項目 | 結果 | 備考 |
|---|-----------|------|------|
| 1 | ndfプラグインが正常に再読み込みできること | ✅ | 正常に実行 |
| 2 | `/ndf:pr-tests`コマンドがヘルプに表示されること | ✅ | 正常に実行 |
| 3 | plugin.jsonのバージョンが2.3.0に更新されていること | ✅ | 正常に実行 |
| 4 | README.mdにコマンド説明が追加されていること | ✅ | 正常に実行 |
| 5 | commands/pr-tests.mdが正しいマークダウン形式であること | ❌ | エラー: 構文エラーが検出されました |
| 6 | issues/i08.mdのタスク#3が完了としてマークされていること | ✅ | 正常に実行 |

## 追加したPRコメント

### 失敗したテスト
- **commands/pr-tests.mdの構文チェック**: 問題点と対策案を#123456に追加

### 最終報告
- テスト結果サマリーを#123457に追加

## 次のアクション

1. PRコメント#123456で構文エラーの対策案を確認
2. commands/pr-tests.mdを修正
3. 修正後に再度`/ndf:pr-tests`を実行してテストが成功することを確認
```
